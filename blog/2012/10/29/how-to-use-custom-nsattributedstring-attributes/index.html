
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>How to use custom NSAttributedString attributes - Cocoa Factory</title>
  <meta name="author" content="Alan Duncan">

  
  <meta name="description" content="How to draw a custom attribute in NSLayoutManager The Cocoa Text System is incredibly flexible; but not nearly as well-documented as it should be &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://cocoa-factory.github.com/blog/2012/10/29/how-to-use-custom-nsattributedstring-attributes/">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Cocoa Factory" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=PT+Sans+Narrow' rel='stylesheet' type='text/css'>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Cocoa Factory</a></h1>
  
    <h2>Industrial strength software for iOS and Mac</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:cocoa-factory.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/about">About</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/products">Products</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">How to Use Custom NSAttributedString Attributes</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-29T19:36:00-05:00" pubdate data-updated="true">Oct 29<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>How to draw a custom attribute in <code>NSLayoutManager</code></h2>

<p>The Cocoa Text System is incredibly flexible; but not nearly as well-documented as it should be given its power.  The classes and methods themselves are completely documented as is the &#8220;big picture&#8221; - but there&#8217;s a lot of intermediate documentation that&#8217;s missing.</p>

<p>In this tutorial, we&#8217;ll build an app that draws a custom attribute in an <code>NSTextView</code> like this:</p>

<p><img src="http://i.imgur.com/mErdK.png" alt="CustomAttributeTestApp" /></p>

<p><code>NSAttributedString</code> is great for drawing standard attributes such as font, font size, foreground and background colors; but it gets more complicated when you need to some something that requires actual drawing.  This tutorial will show you how to do simple drawing of a custom attribute.</p>

<h3>Getting Started</h3>

<p>Download the <a href="https://github.com/cocoa-factory/CCFCustomAttributeTutorial/zipball/master">example project</a> from Github.  You need Xcode 4.5 for this project; so if you don&#8217;t have it - go update Xcode first.</p>

<h3><code>NSAttributedString</code> for decorated text</h3>

<p><code>NSAttributedString</code> and its mutable counterpart <code>NSMutableAttributedString</code> are used to draw decorated text.  Using these classes, you can create strings with attributes that describe how the string should look when drawn.  For example, you can add font and color attributes like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSString</span> <span class="o">*</span><span class="n">sampleString</span> <span class="o">=</span> <span class="s">@&quot;This is a sample string&quot;</span><span class="p">;</span>
</span><span class='line'><span class="n">NSAttributedString</span> <span class="o">*</span><span class="n">attributedString</span><span class="p">;</span>
</span><span class='line'><span class="n">attributedString</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSAttributedString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithString:</span><span class="n">sampleString</span>
</span><span class='line'>                                                   <span class="nl">attributes:</span><span class="err">@</span><span class="p">{</span><span class="nl">NSFontSizeAttribute:</span><span class="err">@</span><span class="mi">24</span><span class="p">}];</span>
</span></code></pre></td></tr></table></div></figure>


<p>This creates a string whose font size attribute is 24.0 pt.  And if we want to display the <code>attributedString</code> in an <code>NSTextView</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSTextView</span> <span class="o">*</span><span class="n">textView</span><span class="p">;</span>
</span><span class='line'><span class="p">[</span><span class="n">textView</span> <span class="nl">setAttributedString:</span><span class="n">attributedString</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>With the mutable variant <code>NSMutableAttributedString</code> you can add and remove attributes dynamically:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSMutableAttributedString</span> <span class="o">*</span><span class="n">string</span><span class="p">;</span>
</span><span class='line'><span class="n">string</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSMutableAttributedString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithString:</span><span class="s">@&quot;The quick brown fox&quot;</span>
</span><span class='line'>              <span class="nl">attributes:</span><span class="err">@</span><span class="p">{</span><span class="n">NSBackgroundColorAttributeName</span> <span class="o">:</span> <span class="p">[</span><span class="n">NSColor</span> <span class="n">yellowColor</span><span class="p">]}];</span>
</span></code></pre></td></tr></table></div></figure>


<p>which will render like this:</p>

<p><img src="http://i.imgur.com/qMnbA.png" alt="background-color" /></p>

<p>Of course, you can also combine attributes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSMutableDictionary</span> <span class="o">*</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSMutableDictionary</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">attributes</span> <span class="nl">setObject:</span><span class="p">[</span><span class="n">NSColor</span> <span class="n">yellowColor</span><span class="p">]</span> <span class="nl">forKey:</span><span class="n">NSBackgroundColorAttributeName</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSFont</span> <span class="o">*</span><span class="n">font</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSFontManager</span> <span class="n">sharedFontManager</span><span class="p">]</span> <span class="nl">fontWithFamily:</span><span class="s">@&quot;Arial&quot;</span> <span class="nl">traits:</span><span class="mi">0</span> <span class="nl">weight:</span><span class="mi">5</span> <span class="nl">size:</span><span class="mi">24</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">attributes</span> <span class="nl">setObject:</span><span class="n">font</span> <span class="nl">forKey:</span><span class="n">NSFontAttributeName</span><span class="p">];</span>
</span><span class='line'>    <span class="n">NSMutableAttributedString</span> <span class="o">*</span><span class="n">string</span><span class="p">;</span>
</span><span class='line'>    <span class="n">string</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSMutableAttributedString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithString:</span><span class="s">@&quot;The quick brown fox&quot;</span>
</span><span class='line'>                                                    <span class="nl">attributes:</span><span class="n">attributes</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[[</span><span class="n">self</span> <span class="n">textView</span><span class="p">]</span> <span class="nl">insertText:</span><span class="n">string</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://i.imgur.com/J4EWm.png" alt="Combining attributes" /></p>

<h3><code>NSMutableAttributedString</code> tracks changes to its string</h3>

<p>If you want to change the underlying <code>NSMutableAttributedString</code> without disturbing its attributes, you can use its <code>mutableString</code> method to obtain an <code>NSMutableString</code> that you can manipulate behind its back, while the <code>NSMutableAttributedString</code> tracks the changes.  In fact the object you get back from <code>mutableString</code> is not actually an instance of <code>NSMutableString</code> but an instance of <code>NSMutableStringProxyForMutableAttributedString</code> instead.  This proxy object is responsible for the tracking behavior internally.</p>

<h3>What about custom attributes, then?</h3>

<p>Let&#8217;s get started building the custom attribute.  The drawing is done in the context of a layout manager - a subclass of <code>NSLayoutManager</code> Since our intent is to use our custom attribute in the context of an <code>NSTextView</code> we should look at the architecture of that class first.  <code>NSTextView</code> has a single text container in which is lays out text.  The <code>NSTextContainer</code> is a rectangular region in which to layout text.  Each <code>NSTextView</code> has a default text container, but it is possible to replace the text container using the <code>replaceTextContainer</code> method.  The text container uses a layout manager to layout and draw the text.  There is readonly access to the text container&#8217;s layout manager on <code>NSTextView</code>.  In order to give <code>NSTextView</code> a new layout manager, we have to set it on a new <code>NSTextContainer</code> object.</p>

<p>So let&#8217;s start with a custom text view that we&#8217;ll call <code>CCFTextView</code>.  You can find the source code in the &#8220;view&#8221; folder.  This text view basically does on thing - replace its <code>NSLayoutManager</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">static</span> <span class="n">CCFTextView</span> <span class="o">*</span><span class="nf">commonInit</span><span class="p">(</span><span class="n">CCFTextView</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//  set up our initial text size</span>
</span><span class='line'>    <span class="n">NSFont</span> <span class="o">*</span><span class="n">font</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSFontManager</span> <span class="n">sharedFontManager</span><span class="p">]</span> <span class="nl">fontWithFamily:</span><span class="s">@&quot;Helvetica&quot;</span> <span class="nl">traits:</span><span class="mi">0</span> <span class="nl">weight:</span><span class="mi">5</span> <span class="nl">size:</span><span class="mf">24.0</span><span class="p">];</span>
</span><span class='line'>    <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">attributes</span> <span class="o">=</span> <span class="err">@</span><span class="p">{</span><span class="n">NSFontAttributeName</span> <span class="o">:</span> <span class="n">font</span><span class="p">};</span>
</span><span class='line'>    <span class="p">[</span><span class="n">self</span> <span class="nl">setTypingAttributes:</span><span class="n">attributes</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  replace our layout manager with custom layout manager</span>
</span><span class='line'>    <span class="n">CCFCustomLayoutManager</span> <span class="o">*</span><span class="n">layoutManager</span> <span class="o">=</span> <span class="p">[[</span><span class="n">CCFCustomLayoutManager</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>    <span class="n">NSTextContainer</span> <span class="o">*</span><span class="n">textContainer</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSTextContainer</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="n">self</span> <span class="nl">replaceTextContainer:</span><span class="n">textContainer</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">textContainer</span> <span class="nl">replaceLayoutManager:</span><span class="n">layoutManager</span><span class="p">];</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>commonInit</code> function is called from either <code>initWithCoder:</code> or <code>initWithFrame:</code> so that no matter how the <code>CCFTextView</code> gets initialized, we replace its text container&#8217;s layout manager with our own subclass.  Let&#8217;s look at the <code>NSLayoutManager</code> subclass - <code>CCFCustomLayoutManager</code> in the &#8220;helpers+managers&#8221; directory.  In the header file &#8220;CCFCustomLayouManager.h&#8221; we define a few constants.  <code>CCFSpecialHighlighterAttributeName</code> is the name of our custom attribute and <code>CCFHighlightColorKey</code> and <code>CCFLineColorKey</code> are keys to the dictionary value of our attribute.</p>

<p>In the implementation of our layout manager, we override a single method <code>drawGlyphsForGlyphRange:atPoint:</code>.  Here we&#8217;ll digress about glyphs vs. characters.</p>

<h3>Glyphs versus characters</h3>

<p>The <strong>character</strong> can is the smallest unit of a written language that has meaning.  In Roman and other alphabets, it maps to a particular sound in the spoken counterpart of the written language.  However in the case of other languages, like Chinese, it can represent an entire word.</p>

<p>A <strong>glyph</strong> on the other hand is a graphically-concrete form of a character.</p>

<p><img src="http://i.imgur.com/3z2M5.png" alt="Glyphs-vs-characters" /></p>

<p>The distinction is important, because while we&#8217;re manipulating characters in our code, the text system is working behind the scenes laying out glyphs, not characters.  In this case, we need to do both.  That&#8217;s why out <code>NSLayoutManager</code> subclass overrides <code>drawGlyphsForGlyphRange:atPoint</code>.  So let&#8217;s look a little more closely at what we do in this method, which we&#8217;ll build up from pseudo-code</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">drawGlyphsForGlyphRange:</span><span class="p">(</span><span class="n">NSRange</span><span class="p">)</span><span class="nv">glyphsToShow</span> <span class="nf">atPoint:</span><span class="p">(</span><span class="n">NSPoint</span><span class="p">)</span><span class="nv">origin</span> <span class="p">{</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     iterate over our glyph ranges</span>
</span><span class='line'><span class="cm">     map the glyph range back to the character range that it represents</span>
</span><span class='line'><span class="cm">     check if our attribute is set on the character range</span>
</span><span class='line'><span class="cm">     if attribute is set</span>
</span><span class='line'><span class="cm">         get the rect of where we should draw the glyph</span>
</span><span class='line'><span class="cm">         do our drawing</span>
</span><span class='line'><span class="cm">    */</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>First, since we need to refer to the character sequence when we do the mapping, we need a source for that mapping.  Fortunately, <code>NSLayoutManager</code> keeps a reference to its <code>NSTextStorage</code> object.  This object is a subclass of <code>NSMutableAttributedString</code>.  We will get this reference and copy <code>glyphsToShow</code> to a local variable so that we can iterate over its span.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">drawGlyphsForGlyphRange:</span><span class="p">(</span><span class="n">NSRange</span><span class="p">)</span><span class="nv">glyphsToShow</span> <span class="nf">atPoint:</span><span class="p">(</span><span class="n">NSPoint</span><span class="p">)</span><span class="nv">origin</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">NSTextStorage</span> <span class="o">*</span><span class="n">textStorage</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">textStorage</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSRange</span> <span class="n">glyphRange</span> <span class="o">=</span> <span class="n">glyphsToShow</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">glyphRange</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="cm">/*</span>
</span><span class='line'><span class="cm">     map the glyph range back to the character range that it represents</span>
</span><span class='line'><span class="cm">     check if our attribute is set on the character range</span>
</span><span class='line'><span class="cm">     if attribute is set</span>
</span><span class='line'><span class="cm">         get the rect of where we should draw the glyph</span>
</span><span class='line'><span class="cm">         do our drawing</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, we take care of the glyph-to-character mapping:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">drawGlyphsForGlyphRange:</span><span class="p">(</span><span class="n">NSRange</span><span class="p">)</span><span class="nv">glyphsToShow</span> <span class="nf">atPoint:</span><span class="p">(</span><span class="n">NSPoint</span><span class="p">)</span><span class="nv">origin</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">NSTextStorage</span> <span class="o">*</span><span class="n">textStorage</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">textStorage</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSRange</span> <span class="n">glyphRange</span> <span class="o">=</span> <span class="n">glyphsToShow</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">glyphRange</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">NSRange</span> <span class="n">charRange</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">characterRangeForGlyphRange:</span><span class="n">glyphRange</span> <span class="nl">actualGlyphRange:</span><span class="nb">NULL</span><span class="p">];</span>
</span><span class='line'>        <span class="n">NSRange</span> <span class="n">attributeCharRange</span><span class="p">,</span> <span class="n">attributeGlyphRange</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">id</span> <span class="n">attribute</span> <span class="o">=</span> <span class="p">[</span><span class="n">textStorage</span> <span class="nl">attribute:</span><span class="n">CCFSpecialHighlightAttributeName</span>
</span><span class='line'>                                      <span class="nl">atIndex:</span><span class="n">charRange</span><span class="p">.</span><span class="n">location</span> <span class="nl">longestEffectiveRange:</span><span class="o">&amp;</span><span class="n">attributeCharRange</span>
</span><span class='line'>                                      <span class="nl">inRange:</span><span class="n">charRange</span><span class="p">];</span>
</span><span class='line'>        <span class="n">attributeGlyphRange</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">glyphRangeForCharacterRange:</span><span class="n">attributeCharRange</span> <span class="nl">actualCharacterRange:</span><span class="nb">NULL</span><span class="p">];</span>
</span><span class='line'>        <span class="n">attributeGlyphRange</span> <span class="o">=</span> <span class="n">NSIntersectionRange</span><span class="p">(</span><span class="n">attributeGlyphRange</span><span class="p">,</span> <span class="n">glyphRange</span><span class="p">);</span>
</span><span class='line'>      <span class="cm">/*</span>
</span><span class='line'><span class="cm">     check if our attribute is set on the character range</span>
</span><span class='line'><span class="cm">     if attribute is set</span>
</span><span class='line'><span class="cm">         get the rect of where we should draw the glyph</span>
</span><span class='line'><span class="cm">         do our drawing</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then to check if the attribute is set on this <code>charRange</code>, we just test for non-nil:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">drawGlyphsForGlyphRange:</span><span class="p">(</span><span class="n">NSRange</span><span class="p">)</span><span class="nv">glyphsToShow</span> <span class="nf">atPoint:</span><span class="p">(</span><span class="n">NSPoint</span><span class="p">)</span><span class="nv">origin</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">NSTextStorage</span> <span class="o">*</span><span class="n">textStorage</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">textStorage</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSRange</span> <span class="n">glyphRange</span> <span class="o">=</span> <span class="n">glyphsToShow</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">glyphRange</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">NSRange</span> <span class="n">charRange</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">characterRangeForGlyphRange:</span><span class="n">glyphRange</span> <span class="nl">actualGlyphRange:</span><span class="nb">NULL</span><span class="p">];</span>
</span><span class='line'>        <span class="n">NSRange</span> <span class="n">attributeCharRange</span><span class="p">,</span> <span class="n">attributeGlyphRange</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">id</span> <span class="n">attribute</span> <span class="o">=</span> <span class="p">[</span><span class="n">textStorage</span> <span class="nl">attribute:</span><span class="n">CCFSpecialHighlightAttributeName</span>
</span><span class='line'>                                      <span class="nl">atIndex:</span><span class="n">charRange</span><span class="p">.</span><span class="n">location</span> <span class="nl">longestEffectiveRange:</span><span class="o">&amp;</span><span class="n">attributeCharRange</span>
</span><span class='line'>                                      <span class="nl">inRange:</span><span class="n">charRange</span><span class="p">];</span>
</span><span class='line'>        <span class="n">attributeGlyphRange</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">glyphRangeForCharacterRange:</span><span class="n">attributeCharRange</span> <span class="nl">actualCharacterRange:</span><span class="nb">NULL</span><span class="p">];</span>
</span><span class='line'>        <span class="n">attributeGlyphRange</span> <span class="o">=</span> <span class="n">NSIntersectionRange</span><span class="p">(</span><span class="n">attributeGlyphRange</span><span class="p">,</span> <span class="n">glyphRange</span><span class="p">);</span>
</span><span class='line'>      
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="n">attribute</span> <span class="o">!=</span> <span class="nb">nil</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="cm">/*</span>
</span><span class='line'><span class="cm">             get the rect of where we should draw the glyph</span>
</span><span class='line'><span class="cm">             do our drawing</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, the drawing is the easiest part.  We just need to bracket our drawing code with calls to save then restore the <code>NSGraphicsContext</code> before drawing.  To get the rectangle in which our glyph is drawn, we ask for the <code>boundingRectForGlyphRange:inTextContainer:</code>.  Lastly, we have our completed implementation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">drawGlyphsForGlyphRange:</span><span class="p">(</span><span class="n">NSRange</span><span class="p">)</span><span class="nv">glyphsToShow</span> <span class="nf">atPoint:</span><span class="p">(</span><span class="n">NSPoint</span><span class="p">)</span><span class="nv">origin</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSTextStorage</span> <span class="o">*</span><span class="n">textStorage</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">textStorage</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSRange</span> <span class="n">glyphRange</span> <span class="o">=</span> <span class="n">glyphsToShow</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">glyphRange</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSRange</span> <span class="n">charRange</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">characterRangeForGlyphRange:</span><span class="n">glyphRange</span> <span class="nl">actualGlyphRange:</span><span class="nb">NULL</span><span class="p">];</span>
</span><span class='line'>        <span class="n">NSRange</span> <span class="n">attributeCharRange</span><span class="p">,</span> <span class="n">attributeGlyphRange</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">id</span> <span class="n">attribute</span> <span class="o">=</span> <span class="p">[</span><span class="n">textStorage</span> <span class="nl">attribute:</span><span class="n">CCFSpecialHighlightAttributeName</span>
</span><span class='line'>                                      <span class="nl">atIndex:</span><span class="n">charRange</span><span class="p">.</span><span class="n">location</span> <span class="nl">longestEffectiveRange:</span><span class="o">&amp;</span><span class="n">attributeCharRange</span>
</span><span class='line'>                                      <span class="nl">inRange:</span><span class="n">charRange</span><span class="p">];</span>
</span><span class='line'>        <span class="n">attributeGlyphRange</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">glyphRangeForCharacterRange:</span><span class="n">attributeCharRange</span> <span class="nl">actualCharacterRange:</span><span class="nb">NULL</span><span class="p">];</span>
</span><span class='line'>        <span class="n">attributeGlyphRange</span> <span class="o">=</span> <span class="n">NSIntersectionRange</span><span class="p">(</span><span class="n">attributeGlyphRange</span><span class="p">,</span> <span class="n">glyphRange</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span> <span class="n">attribute</span> <span class="o">!=</span> <span class="nb">nil</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="p">[</span><span class="n">NSGraphicsContext</span> <span class="n">saveGraphicsState</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">NSColor</span> <span class="o">*</span><span class="n">bgColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">attribute</span> <span class="nl">objectForKey:</span><span class="n">CCFHighlightColorKey</span><span class="p">];</span>
</span><span class='line'>            <span class="n">NSColor</span> <span class="o">*</span><span class="n">lineColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">attribute</span> <span class="nl">objectForKey:</span><span class="n">CCFLineColorKey</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">NSTextContainer</span> <span class="o">*</span><span class="n">textContainer</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">textContainers</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>            <span class="n">NSRect</span> <span class="n">boundingRect</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">boundingRectForGlyphRange:</span><span class="n">attributeGlyphRange</span> <span class="nl">inTextContainer:</span><span class="n">textContainer</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>            <span class="p">[</span><span class="n">bgColor</span> <span class="n">setFill</span><span class="p">];</span>
</span><span class='line'>            <span class="n">NSRectFill</span><span class="p">(</span><span class="n">boundingRect</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">NSRect</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">NSMakeRect</span><span class="p">(</span><span class="n">NSMinX</span><span class="p">(</span><span class="n">boundingRect</span><span class="p">),</span> <span class="n">NSMaxY</span><span class="p">(</span><span class="n">boundingRect</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">NSWidth</span><span class="p">(</span><span class="n">boundingRect</span><span class="p">),</span> <span class="mf">1.0f</span><span class="p">);</span>
</span><span class='line'>            <span class="p">[</span><span class="n">lineColor</span> <span class="n">setFill</span><span class="p">];</span>
</span><span class='line'>            <span class="n">NSRectFill</span><span class="p">(</span><span class="n">bottom</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">NSRect</span> <span class="n">topRect</span> <span class="o">=</span> <span class="n">NSMakeRect</span><span class="p">(</span><span class="n">NSMinX</span><span class="p">(</span><span class="n">boundingRect</span><span class="p">),</span> <span class="n">NSMinY</span><span class="p">(</span><span class="n">boundingRect</span><span class="p">),</span> <span class="n">NSWidth</span><span class="p">(</span><span class="n">boundingRect</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'>            <span class="n">NSRectFill</span><span class="p">(</span><span class="n">topRect</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="p">[</span><span class="n">super</span> <span class="nl">drawGlyphsForGlyphRange:</span><span class="n">attributeGlyphRange</span> <span class="nl">atPoint:</span><span class="n">origin</span><span class="p">];</span>
</span><span class='line'>            <span class="p">[</span><span class="n">NSGraphicsContext</span> <span class="n">restoreGraphicsState</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="p">[</span><span class="n">super</span> <span class="nl">drawGlyphsForGlyphRange:</span><span class="n">glyphsToShow</span> <span class="nl">atPoint:</span><span class="n">origin</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">glyphRange</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">NSMaxRange</span><span class="p">(</span><span class="n">glyphRange</span><span class="p">)</span> <span class="o">-</span> <span class="n">NSMaxRange</span><span class="p">(</span><span class="n">attributeGlyphRange</span><span class="p">);</span>
</span><span class='line'>        <span class="n">glyphRange</span><span class="p">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">NSMaxRange</span><span class="p">(</span><span class="n">attributeGlyphRange</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Setting attributes</h3>

<p>Let&#8217;s turn our attention to <code>CCFMainWindowController</code> where our attributes are being managed.  When the user presses the highlight button, we want to tell the text view to apply our attribute to the selection - which is what we do in <code>setCustomAttribute:</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">IBAction</span><span class="p">)</span><span class="nf">setCustomAttribute:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">sender</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//  add our custom attribute to the selected range</span>
</span><span class='line'>    <span class="n">NSRange</span> <span class="n">selectedRange</span> <span class="o">=</span> <span class="p">[[</span><span class="n">self</span> <span class="n">textView</span><span class="p">]</span> <span class="n">selectedRange</span><span class="p">];</span>
</span><span class='line'>    <span class="n">NSTextStorage</span> <span class="o">*</span><span class="n">textStorage</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">textStorage</span><span class="p">;</span>
</span><span class='line'>    <span class="p">[</span><span class="n">textStorage</span> <span class="nl">addAttribute:</span><span class="n">CCFSpecialHighlightAttributeName</span> <span class="nl">value:</span><span class="p">[</span><span class="n">self</span> <span class="n">attributeColors</span><span class="p">]</span> <span class="nl">range:</span><span class="n">selectedRange</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#pragma mark - Private</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  return dictionary of highlight and line colors for our custom attribute&#39;s value</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nf">attributeColors</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="err">@</span><span class="p">{</span>  <span class="n">CCFHighlightColorKey</span> <span class="o">:</span> <span class="n">self</span><span class="p">.</span><span class="n">highlightColorWell</span><span class="p">.</span><span class="n">color</span><span class="p">,</span> <span class="n">CCFLineColorKey</span> <span class="o">:</span> <span class="n">self</span><span class="p">.</span><span class="n">lineColorWell</span><span class="p">.</span><span class="n">color</span> <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The rest of the code in <code>CCFMainWindowController</code> is for setup and for observing for changes in the highlight and line colors.  Using Key-value observing, we are able to detect when the colors change and re-do our markup accordingly.</p>

<p>Athough here&#8217;s much more to the text system in Cocoa you should have a good starting point for custom attributes.</p>

<p>Question? Comments?  Tweet Alan <code>@NSBum</code>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Alan Duncan</span></span>

      








  


<time datetime="2012-10-29T19:36:00-05:00" pubdate data-updated="true">Oct 29<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/cocoa-/'>cocoa,</a>, <a class='category' href='/blog/categories/mac/'>mac</a>, <a class='category' href='/blog/categories/os/'>os</a>, <a class='category' href='/blog/categories/text-/'>text,</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://cocoa-factory.github.com/blog/2012/10/29/how-to-use-custom-nsattributedstring-attributes/" data-via="CocoaFactory" data-counturl="http://cocoa-factory.github.com/blog/2012/10/29/how-to-use-custom-nsattributedstring-attributes/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/10/04/target-conditionals/" title="Previous Post: Target conditionals">&laquo; Target conditionals</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/10/30/style-guide/" title="Next Post: Cocoa Factory Style Guide">Cocoa Factory Style Guide &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Cocoa Factory</h1>
  <p>We design great software for iOS and Mac platforms.  And you can hire us for your next project.  Contact us at info@cocoa-factory.com</p>
</section>
<section>
	<h1>Our open source components</h1>
	<p>Not only do we make great software, we support the developer community by open-sourcing some of what we do.  We plan to more of this, so stay tuned.</p>
	<ul>
		<li><a href="https://github.com/cocoa-factory/CCFNumberPickerView">CCFNumberPickerView</a> A iOS component for choosing number from a continuous scale.</li>
		<li><a href="https://github.com/cocoa-factory/CCFBrowserTextField">CCFBrowserTextField</a>A Mac OS component incorporating a miniature button in an NSTextField</li>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/03/18/auto-incrementing-xcode-build-numbers/">Auto-incrementing Xcode build numbers</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/11/organizing-developer-reference-materials/">Organizing developer reference materials</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/10/app-version-icon-overlays-the-mac-edition/">App version icon overlays:  The Mac edition</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/10/introducing-ccfscrollingtabbar/">Introducing CCFScrollingTabBar</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/01/troubleshooting-cocoapods-installation/">troubleshooting cocoapods installation</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("CocoaFactory", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/CocoaFactory" class="twitter-follow-button" data-show-count="false">Follow @CocoaFactory</a>
  
</section>

<section>
    <h1>Stack Overflow</h1>
<a href="http://stackoverflow.com/users/134245/nsbum">
<img src="http://stackoverflow.com/users/flair/134245.png" width="208" height="58" alt="profile for NSBum at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for NSBum at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
</a>

</section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Alan Duncan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
