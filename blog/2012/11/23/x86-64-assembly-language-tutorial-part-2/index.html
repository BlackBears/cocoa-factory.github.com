
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>x86_64 Assembly Language Tutorial: Part 2 - Cocoa Factory</title>
  <meta name="author" content="Alan Duncan">

  
  <meta name="description" content="In our last installment of our x86_64 assembler tutorial, we introduced the registers and walked through a simple C program and its assembly &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://cocoa-factory.github.com/blog/2012/11/23/x86-64-assembly-language-tutorial-part-2/">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Cocoa Factory" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=PT+Sans+Narrow' rel='stylesheet' type='text/css'>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Cocoa Factory</a></h1>
  
    <h2>Industrial strength software for iOS and Mac</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:cocoa-factory.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/about">About</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/products">Products</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">X86_64 Assembly Language Tutorial: Part 2</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-23T05:34:00-06:00" pubdate data-updated="true">Nov 23<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>In our <a href="http://cocoafactory.com/blog/2012/11/23/x86-64-assembly-language-tutorial-part-1/">last installment</a> of our x86_64 assembler tutorial, we introduced the registers and walked through a simple C program and its assembly langugage counterpart.  This time, we&#8217;ll talk a little more about the effect of optimizations and while we&#8217;re at it, present some of the highlights of the application binary interface, the ABI.</p>

<p>Let&#8217;s start with our original code that we <a href="http://cocoafactory.com/blog/2012/11/23/x86-64-assembly-language-tutorial-part-1/">presented last time</a>:</p>

<div><script src='https://gist.github.com/4135115.js?file='></script>
<noscript><pre><code>#import &lt;Foundation/Foundation.h&gt;

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        uint8_t i;
        for( i = 0; i &lt; 16; i++ ) {
            printf(&quot;i = %d\n&quot;,i);
        }
    }
    return 0;
}</code></pre></noscript></div>


<h3>Optimization setting - -O, O1</h3>

<p><img class="left" src="http://i.imgur.com/O9LQR.png" title="'Figure 1: Optimization setting'" >
This time, we&#8217;re going to set the optimizations differently to see what effect it has on the code.  Recall that we ran with no optimizations the first time.  If you want to follow along in Xcode, then just create a command-line application project and search for &#8216;optimization&#8217; in the target build settings.</p>

<p><img class="right" src="http://i.imgur.com/NcgDW.png" title="'Figure 2: Disassembly assistant setting'" >
Paste the code above into <code>main.m</code> to replace the code that&#8217;s autogenerated by the template; and place a breakpoint on the return line.  We won&#8217;t be able to see the disassembly code unless the application is actually running; so we want to break somewhere accordingly.  We can view either the assembly or disassembly code.  We&#8217;re going to look at the former because the latter contains a lot of debugging symbols that make it harder to understand what we&#8217;re really interested in - the instructions.  To show the disassembly results, build and run the project.  When the debugger stops on the return line, show the Assistant editor which splits the main viewer into two panes.  In the right pane, select Disassembly as the assistant pane content.  If you&#8217;re not with me, then you may want to take a while to get familiar with the Xcode 4.x interface so that you can configure it the way you want.</p>

<h3>Disassembler code</h3>

<p>The disassembler takes the machine code that your C code generated and expresses it symbolically in assembly langugage.  Let&#8217;s take a look at the results and compare it to the results from the <a href="http://cocoafactory.com/blog/2012/11/23/x86-64-assembly-language-tutorial-part-1/">last tutorial</a>.</p>

<div><script src='https://gist.github.com/4135317.js?file='></script>
<noscript><pre><code>0x100000ee0:  pushq  %rbp
0x100000ee1:  movq   %rsp, %rbp
0x100000ee4:  pushq  %r15
0x100000ee6:  pushq  %r14
0x100000ee8:  pushq  %rbx
0x100000ee9:  pushq  %rax
0x100000eea:  callq  0x100000f2e               ; symbol stub for: objc_autoreleasePoolPush
0x100000eef:  movq   %rax, %r14
0x100000ef2:  xorl   %ebx, %ebx
0x100000ef4:  leaq   111(%rip), %r15           ; &quot;i = %d\n&quot;
0x100000efb:  nopl   (%rax,%rax)
0x100000f00:  movq   %r15, %rdi
0x100000f03:  movl   %ebx, %esi
0x100000f05:  xorb   %al, %al
0x100000f07:  callq  0x100000f34               ; symbol stub for: printf
0x100000f0c:  incl   %ebx
0x100000f0e:  cmpb   $16, %bl
0x100000f11:  jne    0x100000f00               ; main + 32 at main.m:17
0x100000f13:  movq   %r14, %rdi
0x100000f16:  callq  0x100000f28               ; symbol stub for: objc_autoreleasePoolPop
0x100000f1b:  xorl   %eax, %eax
0x100000f1d:  addq   $8, %rsp
0x100000f21:  popq   %rbx
0x100000f22:  popq   %r14
0x100000f24:  popq   %r15
0x100000f26:  popq   %rbp
0x100000f27:  ret    </code></pre></noscript></div>


<h3>Step-by-step</h3>

<p>And just like we did before, let&#8217;s look at the code step-by-step.  This time we&#8217;re going to compare it to the code with no optimizations from last time, so you may want to be familiar with it first.</p>

<h4>Step 1 - Preamble</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="mh">0x100000ee0</span><span class="o">:</span>  <span class="n">pushq</span>  <span class="o">%</span><span class="n">rbp</span>
</span><span class='line'><span class="mh">0x100000ee1</span><span class="o">:</span>  <span class="n">movq</span>   <span class="o">%</span><span class="n">rsp</span><span class="p">,</span> <span class="o">%</span><span class="n">rbp</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is the same function preamble as before, saving the current base pointer and moving the stack pointer to the base pointer register.</p>

<h4>Step 2 - Save the registers</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="mh">0x100000ee4</span><span class="o">:</span>  <span class="n">pushq</span>  <span class="o">%</span><span class="n">r15</span>
</span><span class='line'><span class="mh">0x100000ee6</span><span class="o">:</span>  <span class="n">pushq</span>  <span class="o">%</span><span class="n">r14</span>
</span><span class='line'><span class="mh">0x100000ee8</span><span class="o">:</span>  <span class="n">pushq</span>  <span class="o">%</span><span class="n">rbx</span>
</span><span class='line'><span class="mh">0x100000ee9</span><span class="o">:</span>  <span class="n">pushq</span>  <span class="o">%</span><span class="n">rax</span>
</span></code></pre></td></tr></table></div></figure>


<p>We push several 64-bit registers to the stack.  We don&#8217;t know yet; but probably this is because we&#8217;re going to use them later on.  Let&#8217;s see what&#8217;s next.</p>

<h4>Step 3 - Start the autorelease pool</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="mh">0x100000eea</span><span class="o">:</span>  <span class="n">callq</span>  <span class="mh">0x100000f2e</span>               <span class="p">;</span> <span class="n">symbol</span> <span class="n">stub</span> <span class="k">for</span><span class="o">:</span> <span class="n">objc_autoreleasePoolPush</span>
</span><span class='line'><span class="mh">0x100000eef</span><span class="o">:</span>  <span class="n">movq</span>   <span class="o">%</span><span class="n">rax</span><span class="p">,</span> <span class="o">%</span><span class="n">r14</span>
</span></code></pre></td></tr></table></div></figure>


<p>Set up the autorelease pool for the function as before.  This time, we&#8217;re saving the return value - a reference to the autorelease pool, presumably - to <code>%r14</code>.  We&#8217;ll set it again later before we pop the autorelease pool.  But before we do, it&#8217;s a good time to present some of the register allocations from the <a href="http://www.x86-64.org/documentation/abi.pdf">x86_64 ABI</a>.  The ABI exists to create some standardization in the way that assembly code interacts with the machine.  Part of that specification are standards that determine which registers are used for a given purpose.  We&#8217;ll present them here:</p>

<table>
<thead>
<tr>
<th>Register  </th>
<th> Usage                                                           </th>
<th> Preserved across function calls</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>%rax</code>    </td>
<td> 1st return register, number of vector registers used            </td>
<td> No</td>
</tr>
<tr>
<td><code>%rbx</code>    </td>
<td> callee-saved register; base pointer                             </td>
<td> Yes</td>
</tr>
<tr>
<td><code>%rcx</code>    </td>
<td> pass 4th integer argument to functions                          </td>
<td> No</td>
</tr>
<tr>
<td><code>%rdx</code>    </td>
<td> pass 3rd argument fo functions, 2nd return register             </td>
<td> No</td>
</tr>
<tr>
<td><code>%rsp</code>    </td>
<td> stack pointer                                                   </td>
<td> Yes</td>
</tr>
<tr>
<td><code>%rbp</code>    </td>
<td> callee-saved register, frame pointer                            </td>
<td> Yes</td>
</tr>
<tr>
<td><code>%rsi</code>    </td>
<td> used to pass 2nd argument to functions                          </td>
<td> No</td>
</tr>
<tr>
<td><code>%rdi</code>    </td>
<td> used to pass 1st argument to functions                          </td>
<td> No</td>
</tr>
<tr>
<td><code>%r8</code>     </td>
<td> used to pass 5th argunent to functions                          </td>
<td> No</td>
</tr>
<tr>
<td><code>%r9</code>     </td>
<td> used to pass 6th argument to functions                          </td>
<td> No</td>
</tr>
<tr>
<td><code>%r10</code>    </td>
<td> temp register, used for passing a function&#8217;s static chain ptr   </td>
<td> No</td>
</tr>
<tr>
<td><code>%r11</code>    </td>
<td> temp register                                                   </td>
<td> No</td>
</tr>
<tr>
<td><code>%r12</code>    </td>
<td> callee-saved register                                           </td>
<td> Yes</td>
</tr>
<tr>
<td><code>%r13</code>    </td>
<td> callee-saved register                                           </td>
<td> Yes</td>
</tr>
<tr>
<td><code>%r14</code>    </td>
<td> callee-saved register                                           </td>
<td> Yes</td>
</tr>
<tr>
<td><code>%r15</code>    </td>
<td> callee-saved register                                           </td>
<td> Yes</td>
</tr>
<tr>
<td><code>%xmm0</code>   </td>
<td> used to pass and return floating point arguments                </td>
<td> No</td>
</tr>
<tr>
<td><code>%xmm1</code>   </td>
<td> used to pass and return floating point arguments                </td>
<td> No</td>
</tr>
<tr>
<td><code>%xmm2</code>   </td>
<td> used to pass floating point arguments                           </td>
<td> No</td>
</tr>
<tr>
<td><code>%xmm3</code>   </td>
<td> used to pass floating point arguments                           </td>
<td> No</td>
</tr>
<tr>
<td><code>%xmm4</code>   </td>
<td> used to pass floating point arguments                           </td>
<td> No</td>
</tr>
<tr>
<td><code>%xmm5</code>   </td>
<td> used to pass floating point arguments                           </td>
<td> No</td>
</tr>
<tr>
<td><code>%xmm6</code>   </td>
<td> used to pass floating point arguments                           </td>
<td> No</td>
</tr>
<tr>
<td><code>%xmm7</code>   </td>
<td> used to pass floating point arguments                           </td>
<td> No</td>
</tr>
<tr>
<td><code>%xmm8</code>   </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%xmm9</code>   </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%xmm10</code>  </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%xmm11</code>  </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%xmm12</code>  </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%xmm13</code>  </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%xmm14</code>  </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%xmm15</code>  </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%mmx0</code>   </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%mmx1</code>   </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%mmx2</code>   </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%mmx3</code>   </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%mmx4</code>   </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%mmx5</code>   </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%mmx6</code>   </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%mmx7</code>   </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%st0</code>    </td>
<td> temporary register, used to return long double arguments        </td>
<td> No</td>
</tr>
<tr>
<td><code>%st1</code>    </td>
<td> temporary register, used to return long double arguments        </td>
<td> No</td>
</tr>
<tr>
<td><code>%st2</code>    </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%st3</code>    </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%st4</code>    </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%st5</code>    </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%st6</code>    </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
<tr>
<td><code>%st7</code>    </td>
<td> temporary register                                              </td>
<td> No</td>
</tr>
</tbody>
</table>


<p>Whew! Got that memorized yet?  Oh well, let&#8217;s move on.</p>

<h4>Step 4 - Idiom for clearing register</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="mh">0x100000ef2</span><span class="o">:</span>  <span class="n">xorl</span>   <span class="o">%</span><span class="n">ebx</span><span class="p">,</span> <span class="o">%</span><span class="n">ebx</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is a curious instruction, XOR long <code>%ebx</code> with itself.  Self-XOR has the effect of clearing the register which on some processors is faster than <code>movl $0, %ebx</code>.  If we&#8217;re setting something to zero, I wonder if the compiler is using <code>%ebx</code> as the loop index.  We shall see&#8230;</p>

<h4>Step 5 - Obtain format string address</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="mh">0x100000ef4</span><span class="o">:</span>  <span class="n">leaq</span>   <span class="mi">111</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span> <span class="o">%</span><span class="n">r15</span>           <span class="p">;</span> <span class="s">&quot;i = %d</span><span class="se">\n</span><span class="s">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This instruction reads &#8220;load effective address 64-bit into <code>%15</code>&#8221;.  We&#8217;re just grabbing the format string from a particular location in memory relative to the instruction pointer.</p>

<h4>Step 6 - Alignment</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="mh">0x100000efb</span><span class="o">:</span>  <span class="n">nopl</span>   <span class="p">(</span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="o">%</span><span class="n">rax</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is an optimization that does nothing other than align the code properly for the jump target so that it can be fetched in a single cacheline request.</p>

<h4>Step 7 - Setting up call to <code>printf</code></h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="mh">0x100000f00</span><span class="o">:</span>  <span class="n">movq</span>   <span class="o">%</span><span class="n">r15</span><span class="p">,</span> <span class="o">%</span><span class="n">rdi</span>
</span><span class='line'><span class="mh">0x100000f03</span><span class="o">:</span>  <span class="n">movl</span>   <span class="o">%</span><span class="n">ebx</span><span class="p">,</span> <span class="o">%</span><span class="n">esi</span>
</span><span class='line'><span class="mh">0x100000f05</span><span class="o">:</span>  <span class="n">xorb</span>   <span class="o">%</span><span class="n">al</span><span class="p">,</span> <span class="o">%</span><span class="n">al</span>
</span><span class='line'><span class="mh">0x100000f07</span><span class="o">:</span>  <span class="n">callq</span>  <span class="mh">0x100000f34</span>               <span class="p">;</span> <span class="n">symbol</span> <span class="n">stub</span> <span class="k">for</span><span class="o">:</span> <span class="n">printf</span>
</span></code></pre></td></tr></table></div></figure>


<p>Remember from the ABI register usage table above that <code>%rdi</code> is used to pass the first argument to functions.  In this case, the format string is the first argument of <code>printf</code>.  Earlier in Step 5, we loaded the address of the string into <code>%r15</code>; now we&#8217;re moving it to <code>%rdi</code> in preparation for the <code>printf</code> function call.  Next, <code>movl   %ebx, %esi</code> - remember earlier we wondered if the compiler was using <code>%esi</code> as the loop index?  From the reference table above, <code>%rsi</code> is used to pass the second function parameter; so this instruction passes the second parameter which is the loop index <code>i</code> in the C code.</p>

<p><code>xorb   %al, %al</code> clears the <code>%al</code> register which is the lowest 8 bits of <code>%rax</code> which is the register that passes the number of vector arguments.  As in the prior tutorial, since we are printing an integer, we don&#8217;t need a vector register.  Hence, we clear <code>%al</code>.</p>

<h4>Step 8 - Increment, compare, and jump</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="mh">0x100000f0c</span><span class="o">:</span>  <span class="n">incl</span>   <span class="o">%</span><span class="n">ebx</span>
</span><span class='line'><span class="mh">0x100000f0e</span><span class="o">:</span>  <span class="n">cmpb</span>   <span class="err">$</span><span class="mi">16</span><span class="p">,</span> <span class="o">%</span><span class="n">bl</span>
</span><span class='line'><span class="mh">0x100000f11</span><span class="o">:</span>  <span class="n">jne</span>    <span class="mh">0x100000f00</span>               <span class="p">;</span> <span class="n">main</span> <span class="o">+</span> <span class="mi">32</span> <span class="n">at</span> <span class="n">main</span><span class="p">.</span><span class="n">m</span><span class="o">:</span><span class="mi">17</span>
</span></code></pre></td></tr></table></div></figure>


<p>In order, we increment the register we&#8217;re using for the loop index, compare its lower 8 bits to decimal 16 with a byte compare instruction and jump if not equal back to Step 7.</p>

<h4>Step 9 - Pop the autorelease pool</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="mh">0x100000f13</span><span class="o">:</span>  <span class="n">movq</span>   <span class="o">%</span><span class="n">r14</span><span class="p">,</span> <span class="o">%</span><span class="n">rdi</span>
</span><span class='line'><span class="mh">0x100000f16</span><span class="o">:</span>  <span class="n">callq</span>  <span class="mh">0x100000f28</span>               <span class="p">;</span> <span class="n">symbol</span> <span class="n">stub</span> <span class="k">for</span><span class="o">:</span> <span class="n">objc_autoreleasePoolPop</span>
</span></code></pre></td></tr></table></div></figure>


<p>Recall that in Step 3 we saved a reference to the autorelease pool in <code>%r14</code>?  Now we move that reference back to <code>%rdi</code> which is used to pass the first argument to functions. (Is this sounding like a broken record now?)  Then we call objc_autoreleasePoolPop in the Objective-C runtime to release the autorelease pool.</p>

<h4>Step 10 - Setting up to return</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="mh">0x100000f1b</span><span class="o">:</span>  <span class="n">xorl</span>   <span class="o">%</span><span class="n">eax</span><span class="p">,</span> <span class="o">%</span><span class="n">eax</span>
</span><span class='line'><span class="mh">0x100000f1d</span><span class="o">:</span>  <span class="n">addq</span>   <span class="err">$</span><span class="mi">8</span><span class="p">,</span> <span class="o">%</span><span class="n">rsp</span>
</span><span class='line'><span class="mh">0x100000f21</span><span class="o">:</span>  <span class="n">popq</span>   <span class="o">%</span><span class="n">rbx</span>
</span><span class='line'><span class="mh">0x100000f22</span><span class="o">:</span>  <span class="n">popq</span>   <span class="o">%</span><span class="n">r14</span>
</span><span class='line'><span class="mh">0x100000f24</span><span class="o">:</span>  <span class="n">popq</span>   <span class="o">%</span><span class="n">r15</span>
</span><span class='line'><span class="mh">0x100000f26</span><span class="o">:</span>  <span class="n">popq</span>   <span class="o">%</span><span class="n">rbp</span>
</span><span class='line'><span class="mh">0x100000f27</span><span class="o">:</span>  <span class="n">ret</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now all that&#8217;s left is just to clean up.  First we clear <code>%eax</code>.  Why now?  Since it&#8217;s the lower 32 bits of the first return register, we just clear it after returning from the last function call so that we can return 0 to <strong>our</strong> caller.</p>

<p>Next we add 8 to the stack pointer.  This is an interesting development.  Why do we manually adjust the stack pointer?  Take a look at the function setup.  Initially we pushed the following registers: <code>%rbp</code>, <code>%r15</code>, <code>%r14</code>, <code>%rbx</code> and <code>%rax</code>.  But if we pop <code>%rax</code> which is our 1st function return value register, then we risk blowing away the effects of clearing <code>%eax</code> that we just did in <code>0x100000f1b:  xorl   %eax, %eax</code>, right?  So instead of popping the value, we manually adjust the stack pointer before popping the other variables in the reverse order to that in which we pushed them to the stack.</p>

<p>Lastly, we return to the caller.</p>

<p>Again, we close another chapter in our x86_64 assembly tutorial for Mac.  We will continue to build on our knowledge base with slightly more complex tutorials as we progress; so stay tuned.  Here are some interesting and useful references for you:</p>

<ul>
<li><a href="http://www.x86-64.org/documentation/abi.pdf">x86_64 ABI reference</a></li>
<li><a href="http://www.cs.virginia.edu/~evans/cs216/guides/x86.html">x86 assembly guide</a></li>
<li><a href="http://cs.mtu.edu/~mmkoksal/blog/?x=entry:entry120116-130037">GNU assembler directives</a></li>
<li><a href="http://stackoverflow.com/questions/2647640/x86-assembly-idioms">x86 assembly idioms</a></li>
</ul>


<p>And of course, <a href="http://cocoafactory.com/blog/2012/11/23/x86-64-assembly-language-tutorial-part-1/">Part I</a> or our tutorial.</p>

<p>Question? Comments?  Tweet Alan <code>@NSBum</code>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Alan Duncan</span></span>

      








  


<time datetime="2012-11-23T05:34:00-06:00" pubdate data-updated="true">Nov 23<span>rd</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/assembler/'>assembler</a>, <a class='category' href='/blog/categories/macos/'>macos</a>, <a class='category' href='/blog/categories/tutorial/'>tutorial</a>, <a class='category' href='/blog/categories/x86-64/'>x86_64</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://cocoa-factory.github.com/blog/2012/11/23/x86-64-assembly-language-tutorial-part-2/" data-via="CocoaFactory" data-counturl="http://cocoa-factory.github.com/blog/2012/11/23/x86-64-assembly-language-tutorial-part-2/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/11/23/x86-64-assembly-language-tutorial-part-1/" title="Previous Post: x86_64 Assembly Language Tutorial: Part 1">&laquo; x86_64 Assembly Language Tutorial: Part 1</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/11/23/x86-64-assembly-language-tutorial-part-3/" title="Next Post: x86_64 Assembly Language Tutorial: Part 3">x86_64 Assembly Language Tutorial: Part 3 &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Cocoa Factory</h1>
  <p>We design great software for iOS and Mac platforms.  And you can hire us for your next project.  Contact us at info@cocoa-factory.com</p>
</section>
<section>
	<h1>Our open source components</h1>
	<p>Not only do we make great software, we support the developer community by open-sourcing some of what we do.  We plan to more of this, so stay tuned.</p>
	<ul>
		<li><a href="https://github.com/cocoa-factory/CCFNumberPickerView">CCFNumberPickerView</a> A iOS component for choosing number from a continuous scale.</li>
		<li><a href="https://github.com/cocoa-factory/CCFBrowserTextField">CCFBrowserTextField</a>A Mac OS component incorporating a miniature button in an NSTextField</li>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/12/17/expanding-nsoutlineview-at-load-time/">Expanding NSOutlineView at load time</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/16/lldb-print-registers/">LLDB print registers</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/15/announcing-regexmatch-for-mac/">Announcing RegexMatch for Mac</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/28/forgetting-sandbox-entitlements/">Forgetting Sandbox entitlements</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/24/x86-64-assembly-language-tutorial-part-4/">x86_64 Assembly language tutorial:part 4</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("CocoaFactory", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/CocoaFactory" class="twitter-follow-button" data-show-count="false">Follow @CocoaFactory</a>
  
</section>

<section>
    <h1>Stack Overflow</h1>
<a href="http://stackoverflow.com/users/134245/nsbum">
<img src="http://stackoverflow.com/users/flair/134245.png" width="208" height="58" alt="profile for NSBum at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for NSBum at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
</a>

</section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Alan Duncan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
